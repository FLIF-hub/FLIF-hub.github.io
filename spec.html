<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.5">
<meta name="author" content="Jon Sneyers, other contributors: add yourself here">
<title>FLIF16 Specification</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Remove comment around @import statement below when using as a custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
[hidden],template{display:none}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
input[type="search"]{-webkit-appearance:textfield;-moz-box-sizing:content-box;-webkit-box-sizing:content-box;box-sizing:content-box}
input[type="search"]::-webkit-search-cancel-button,input[type="search"]::-webkit-search-decoration{-webkit-appearance:none}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*:before,*:after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.spread{width:100%}
p.lead,.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{font-size:1.21875em;line-height:1.6}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #ddddd8;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol,ul.no-bullet,ol.no-bullet{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.no-bullet{list-style:none}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite:before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media only screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7;font-weight:bold}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix:before,.clearfix:after,.float-group:before,.float-group:after{content:" ";display:table}
.clearfix:after,.float-group:after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
*:not(pre)>code.nobreak{word-wrap:normal}
*:not(pre)>code.nowrap{white-space:nowrap}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menu{color:rgba(0,0,0,.8)}
b.button:before,b.button:after{position:relative;top:-1px;font-weight:400}
b.button:before{content:"[";padding:0 3px 0 2px}
b.button:after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header:before,#header:after,#content:before,#content:after,#footnotes:before,#footnotes:after,#footer:before,#footer:after{content:" ";display:table}
#header:after,#content:after,#footnotes:after,#footer:after{clear:both}
#content{margin-top:1.25em}
#content:before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #ddddd8}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #ddddd8;padding-bottom:8px}
#header .details{border-bottom:1px solid #ddddd8;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span:before{content:"\00a0\2013\00a0"}
#header .details br+span.author:before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark:before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber:after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #ddddd8;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #efefed;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media only screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #efefed;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #efefed;left:auto;right:0}}
@media only screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
.sect1{padding-bottom:.625em}
@media only screen and (min-width:768px){.sect1{padding-bottom:1.25em}}
.sect1+.sect1{border-top:1px solid #efefed}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor:before,h2>a.anchor:before,h3>a.anchor:before,#toctitle>a.anchor:before,.sidebarblock>.content>.title>a.anchor:before,h4>a.anchor:before,h5>a.anchor:before,h6>a.anchor:before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock>caption.title{white-space:nowrap;overflow:visible;max-width:0}
.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>.paragraph:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #ddddd8;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;padding:1em;font-size:.8125em}
.literalblock pre.nowrap,.literalblock pre[class].nowrap,.listingblock pre.nowrap,.listingblock pre[class].nowrap{overflow-x:auto;white-space:pre;word-wrap:normal}
@media only screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media only screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]:before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]:before{display:block}
.listingblock.terminal pre .command:before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt]):before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #ddddd8}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock blockquote p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote:before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.5em;margin-right:.5ex;text-align:right}
.quoteblock .quoteblock{margin-left:0;margin-right:0;padding:.5em 0;border-left:3px solid rgba(0,0,0,.6)}
.quoteblock .quoteblock blockquote{padding:0 0 0 .75em}
.quoteblock .quoteblock blockquote:before{display:none}
.verseblock{margin:0 1em 1.25em 1em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract{margin:0 0 1.25em 0;display:block}
.quoteblock.abstract blockquote,.quoteblock.abstract blockquote p{text-align:left;word-spacing:0}
.quoteblock.abstract blockquote:before,.quoteblock.abstract blockquote p:first-of-type:before{display:none}
table.tableblock{max-width:100%;border-collapse:separate}
table.tableblock td>.paragraph:last-child p>p:last-child,table.tableblock th>p:last-child,table.tableblock td>p:last-child{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all th.tableblock,table.grid-all td.tableblock{border-width:0 1px 1px 0}
table.grid-all tfoot>tr>th.tableblock,table.grid-all tfoot>tr>td.tableblock{border-width:1px 1px 0 0}
table.grid-cols th.tableblock,table.grid-cols td.tableblock{border-width:0 1px 0 0}
table.grid-all *>tr>.tableblock:last-child,table.grid-cols *>tr>.tableblock:last-child{border-right-width:0}
table.grid-rows th.tableblock,table.grid-rows td.tableblock{border-width:0 0 1px 0}
table.grid-all tbody>tr:last-child>th.tableblock,table.grid-all tbody>tr:last-child>td.tableblock,table.grid-all thead:last-child>tr>th.tableblock,table.grid-rows tbody>tr:last-child>th.tableblock,table.grid-rows tbody>tr:last-child>td.tableblock,table.grid-rows thead:last-child>tr>th.tableblock{border-bottom-width:0}
table.grid-rows tfoot>tr>th.tableblock,table.grid-rows tfoot>tr>td.tableblock{border-width:1px 0 0 0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot{border-width:1px 0}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.unstyled,ol.unnumbered,ul.checklist,ul.none{list-style-type:none}
ul.unstyled,ol.unnumbered,ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1em;font-size:.85em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{width:1em;position:relative;top:1px}
ul.inline{margin:0 auto .625em auto;margin-left:-1.375em;margin-right:0;padding:0;list-style:none;overflow:hidden}
ul.inline>li{list-style:none;float:left;margin-left:1.375em;display:block}
ul.inline>li>*{display:block}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist>table tr>td:first-of-type{padding:0 .75em;line-height:1}
.colist>table tr>td:last-of-type{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left,.imageblock[style*="float: left"]{margin:.25em .625em 1.25em 0}
.imageblock.right,.imageblock[style*="float: right"]{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em 0;border-width:1px 0 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;text-indent:-1.05em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note:before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip:before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning:before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution:before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important:before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]:after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@media print{@page{margin:1.25cm .75cm}
*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare):after,a[href^="https:"]:not(.bare):after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]:after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #ddddd8!important;padding-bottom:0!important}
.sect1{padding-bottom:0!important}
.sect1+.sect1{border:0!important}
#header>h1:first-child{margin-top:1.25rem}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em 0}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span:before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]:before{display:block}
#footer{background:none!important;padding:0 .9375em}
#footer-text{color:rgba(0,0,0,.6)!important;font-size:.9em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css">
<style>
/* Stylesheet for CodeRay to match GitHub theme | MIT License | http://foundation.zurb.com */
/*pre.CodeRay {background-color:#f7f7f8;}*/
.CodeRay .line-numbers{border-right:1px solid #d8d8d8;padding:0 0.5em 0 .25em}
.CodeRay span.line-numbers{display:inline-block;margin-right:.5em;color:rgba(0,0,0,.3)}
.CodeRay .line-numbers strong{color:rgba(0,0,0,.4)}
table.CodeRay{border-collapse:separate;border-spacing:0;margin-bottom:0;border:0;background:none}
table.CodeRay td{vertical-align: top;line-height:1.45}
table.CodeRay td.line-numbers{text-align:right}
table.CodeRay td.line-numbers>pre{padding:0;color:rgba(0,0,0,.3)}
table.CodeRay td.code{padding:0 0 0 .5em}
table.CodeRay td.code>pre{padding:0}
.CodeRay .debug{color:#fff !important;background:#000080 !important}
.CodeRay .annotation{color:#007}
.CodeRay .attribute-name{color:#000080}
.CodeRay .attribute-value{color:#700}
.CodeRay .binary{color:#509}
.CodeRay .comment{color:#998;font-style:italic}
.CodeRay .char{color:#04d}
.CodeRay .char .content{color:#04d}
.CodeRay .char .delimiter{color:#039}
.CodeRay .class{color:#458;font-weight:bold}
.CodeRay .complex{color:#a08}
.CodeRay .constant,.CodeRay .predefined-constant{color:#008080}
.CodeRay .color{color:#099}
.CodeRay .class-variable{color:#369}
.CodeRay .decorator{color:#b0b}
.CodeRay .definition{color:#099}
.CodeRay .delimiter{color:#000}
.CodeRay .doc{color:#970}
.CodeRay .doctype{color:#34b}
.CodeRay .doc-string{color:#d42}
.CodeRay .escape{color:#666}
.CodeRay .entity{color:#800}
.CodeRay .error{color:#808}
.CodeRay .exception{color:inherit}
.CodeRay .filename{color:#099}
.CodeRay .function{color:#900;font-weight:bold}
.CodeRay .global-variable{color:#008080}
.CodeRay .hex{color:#058}
.CodeRay .integer,.CodeRay .float{color:#099}
.CodeRay .include{color:#555}
.CodeRay .inline{color:#000}
.CodeRay .inline .inline{background:#ccc}
.CodeRay .inline .inline .inline{background:#bbb}
.CodeRay .inline .inline-delimiter{color:#d14}
.CodeRay .inline-delimiter{color:#d14}
.CodeRay .important{color:#555;font-weight:bold}
.CodeRay .interpreted{color:#b2b}
.CodeRay .instance-variable{color:#008080}
.CodeRay .label{color:#970}
.CodeRay .local-variable{color:#963}
.CodeRay .octal{color:#40e}
.CodeRay .predefined{color:#369}
.CodeRay .preprocessor{color:#579}
.CodeRay .pseudo-class{color:#555}
.CodeRay .directive{font-weight:bold}
.CodeRay .type{font-weight:bold}
.CodeRay .predefined-type{color:inherit}
.CodeRay .reserved,.CodeRay .keyword {color:#000;font-weight:bold}
.CodeRay .key{color:#808}
.CodeRay .key .delimiter{color:#606}
.CodeRay .key .char{color:#80f}
.CodeRay .value{color:#088}
.CodeRay .regexp .delimiter{color:#808}
.CodeRay .regexp .content{color:#808}
.CodeRay .regexp .modifier{color:#808}
.CodeRay .regexp .char{color:#d14}
.CodeRay .regexp .function{color:#404;font-weight:bold}
.CodeRay .string{color:#d20}
.CodeRay .string .string .string{background:#ffd0d0}
.CodeRay .string .content{color:#d14}
.CodeRay .string .char{color:#d14}
.CodeRay .string .delimiter{color:#d14}
.CodeRay .shell{color:#d14}
.CodeRay .shell .delimiter{color:#d14}
.CodeRay .symbol{color:#990073}
.CodeRay .symbol .content{color:#a60}
.CodeRay .symbol .delimiter{color:#630}
.CodeRay .tag{color:#008080}
.CodeRay .tag-special{color:#d70}
.CodeRay .variable{color:#036}
.CodeRay .insert{background:#afa}
.CodeRay .delete{background:#faa}
.CodeRay .change{color:#aaf;background:#007}
.CodeRay .head{color:#f8f;background:#505}
.CodeRay .insert .insert{color:#080}
.CodeRay .delete .delete{color:#800}
.CodeRay .change .change{color:#66f}
.CodeRay .head .head{color:#f4f}
</style>
</head>
<body class="article toc2 toc-right">
<div id="header">
<h1>FLIF16 Specification</h1>
<div class="details">
<span id="author" class="author">Jon Sneyers</span><br>
<span id="email" class="email"><a href="mailto:jon@cloudinary.com">jon@cloudinary.com</a></span><br>
<span id="author2" class="author">other contributors: add yourself here</span><br>
<span id="revdate">Work in progress</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_overview_of_the_format">Overview of the format</a></li>
<li><a href="#_notational_conventions">Notational conventions</a></li>
<li><a href="#_part_1_main_header">Part 1: main header</a></li>
<li><a href="#_part_2_metadata">Part 2: metadata</a></li>
<li><a href="#_symbol_encoding">Symbol encoding</a>
<ul class="sectlevel2">
<li><a href="#_uniform_symbol_coding">Uniform Symbol Coding</a></li>
<li><a href="#_near_zero_symbol_coding">Near-zero symbol coding</a></li>
</ul>
</li>
<li><a href="#_part_3_second_header">Part 3: second header</a>
<ul class="sectlevel2">
<li><a href="#_transformation_0_channelcompact">Transformation 0: ChannelCompact</a></li>
<li><a href="#_transformation_1_ycocg">Transformation 1: YCoCg</a></li>
<li><a href="#_transformation_3_permuteplanes">Transformation 3: PermutePlanes</a></li>
<li><a href="#_transformation_4_bounds">Transformation 4: Bounds</a></li>
<li><a href="#_transformation_5_palettealpha">Transformation 5: PaletteAlpha</a></li>
<li><a href="#_transformation_6_palette">Transformation 6: Palette</a></li>
<li><a href="#_transformation_7_colorbuckets">Transformation 7: ColorBuckets</a></li>
<li><a href="#_transformation_10_duplicateframe">Transformation 10: DuplicateFrame</a></li>
<li><a href="#_transformation_11_frameshape">Transformation 11: FrameShape</a></li>
<li><a href="#_transformation_12_framelookback">Transformation 12: FrameLookback</a></li>
</ul>
</li>
<li><a href="#_maniac_entropy_coding">MANIAC entropy coding</a></li>
<li><a href="#_part_4_pixel_data">Part 4: pixel data</a>
<ul class="sectlevel2">
<li><a href="#_non_interlaced_method">Non-Interlaced method</a></li>
<li><a href="#_interlaced_method">Interlaced method</a></li>
<li><a href="#_pixel_encoding">Pixel encoding</a></li>
<li><a href="#_maniac_tree_encoding">MANIAC tree encoding</a></li>
<li><a href="#_checksum">Checksum</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>The Free Lossless Image Format (FLIF) is a lossless image compression format.
It supports grayscale, RGB and RGBA, with a color depth from 1 to 16 bits per channel.
Both still images and animations are supported.
FLIF can handle sparse-color images (e.g. 256 color palettes) effectively.
It has an interlaced and a non-interlaced mode; unlike PNG, interlacing usually does not come with worse compression.
In terms of compression, FLIF usually outperforms other lossless compression formats like PNG, lossless WebP, BPG, JPEG 2000, JPEG XR, JPEG-LS, APNG, MNG, or GIF.</p>
</div>
<div class="paragraph">
<p>This document specifies the FLIF16 bitstream, as implemented by version 0.2 of the reference encoder (<a href="https://github.com/FLIF-hub/FLIF" class="bare">https://github.com/FLIF-hub/FLIF</a>), which was released in September 2016.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_overview_of_the_format">Overview of the format</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A FLIF file consists of 4 parts, with increasingly complicated encoding methods:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The main header, containing basic image metadata: width, height, color depth, number of frames. This information is encoded in a straightforward way, to make it easy to quickly identify a file.</p>
</li>
<li>
<p>Optional metadata chunks. These chunks contain non-pixel data: Exif/XMP metadata, an ICC color profile, &#8230;&#8203; This information is encoded using DEFLATE compression.</p>
</li>
<li>
<p>Second header, containing further information about how the actual pixel data is encoded. This header also describes a chain of transformations that were applied before encoding, which have to be reversed after decoding (e.g. the YCoCg color transform). This information is encoded using CABAC entropy coding.</p>
</li>
<li>
<p>The actual pixel data. This information is encoded using MANIAC entropy coding.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_notational_conventions">Notational conventions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We use '/' to denote integer division.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_part_1_main_header">Part 1: main header</h2>
<div class="sectionbody">
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">4 bytes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Magic</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>"FLIF"</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">4 bits</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Interlacing, animation</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3 = ni still; 4 = i still; 5 = ni anim; 6 = i anim</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">4 bits</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number of channels (<strong>nb_channels</strong>)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1 = Grayscale; 3 = RGB; 4 = RGBA</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1 byte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bytes per channel (<strong>Bpc</strong>)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>'0'</code>,<code>'1'</code>,<code>'2'</code>   (<code>'0'</code>=custom)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">varint</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Width</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>width</strong>-1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">varint</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Height</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>height</strong>-1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">varint</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number of frames (<strong>nb_frames</strong>)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>nb_frames</strong>-2  (only if animation)</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The fifth byte is an ASCII character that can be interpreted as follows:
for non-interlaced still images: <code>'1'</code>=Grayscale, <code>'3'</code>=RGB, <code>'4'</code>=RGBA,
for interlaced images add +0x10 (so <code>'A'</code>=Grayscale, <code>'C'</code>=RGB, <code>'D'</code>=RGBA),
for animations add +0x20 (so <code>'Q'</code>, <code>'S'</code>, <code>'T'</code> for non-interlaced, <code>'a'</code>,<code>'c'</code>,<code>'d'</code> for interlaced).</p>
</div>
<div class="paragraph">
<p>Variable-size integer encoding (varint):</p>
</div>
<div class="ulist">
<ul>
<li>
<p>An unsigned integer (Big-Endian, MSB first) stored on a variable number of bytes.</p>
</li>
<li>
<p>All the bytes except the last one have a '1' as their first bit.</p>
</li>
<li>
<p>The unsigned integer is represented as the concatenation of the remaining 7 bit codewords.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>nb_frames</strong> is 1 for a still image, &gt; 1 for an animation.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_part_2_metadata">Part 2: metadata</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Chunks are defined similar to PNG chunks, except the chunk size is encoded with a variable number of bytes, and there is no chunk CRC.
Also, the first chunk (which is always "FLIF") has no explicit chunk size and is not DEFLATE-compressed.</p>
</div>
<div class="paragraph">
<p>Chunk names are either 4 letters (4 bytes), indicating an optional chunk, or 1 byte with a value below 32, indicating a non-optional chunk.</p>
</div>
<div class="paragraph">
<p>The convention of using upper and lower case letters is kept, but the meaning of the bits is slightly different.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>First letter: uppercase=critical, lowercase=non-critical &#8594; non-critical chunks can be stripped while keeping a valid file (it might be rendered differently though)</p>
</li>
<li>
<p>Second letter: uppercase=public, lowercase=private</p>
</li>
<li>
<p>Third letter: uppercase=needed to correctly display the image (e.g. a color profile), lowercase=can be stripped safely without changing anything visually</p>
</li>
<li>
<p>Fourth letter: uppercase=safe to copy blindly (when editing the actual image data), lowercase=may depend on image data (e.g. contain a thumbnail)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This optional part is a concatenation of chunks that each look like this:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">4 bytes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Chunk name</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">varint</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Chunk length (<em>size</em>)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>size</em> bytes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DEFLATE-compressed chunk content</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The optional chunks are followed by one non-optional chunk with a single-byte chunk name.
Non-optional chunks do not have an explicit chunk size and their content is not DEFLATE-compressed.
Currently the only non-optional chunk has name 0x00 (a NUL byte), which indicates a FLIF16 bitstream.
Future (non-backwards compatible) revisions of the FLIF format will use a different name for this non-optional chunk.</p>
</div>
<div class="paragraph">
<p>If a decoder encounters an unknown optional chunk, it should proceed decoding (optionally it can produce a warning),
as long as the chunk is non-critical.
If a decoder encounters an unknown non-optional chunk, it should fail and produce an error message.</p>
</div>
<div class="paragraph">
<p>The following optional chunks are defined:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Chunk name</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Content (after DEFLATE-decompression)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">iCCP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ICC color profile</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">raw ICC color profile data</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">eXif</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Exif metadata</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>"Exif\0\0"</code> header followed immediately by a TIFF header and the EXIF data</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">eXmp</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">XMP metadata</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">XMP contained within a read-only xpacket with no padding</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect1">
<h2 id="_symbol_encoding">Symbol encoding</h2>
<div class="sectionbody">
<div class="paragraph">
<p>From here on, all values are encoded using arithmetic coding.</p>
</div>
<div class="paragraph">
<p>uni_int(<em>min</em>,<em>max</em>) denotes an integer in the interval <em>min</em>..<em>max</em> (inclusive), encoded using Uniform symbol coding (see below) and a 24-bit RAC. This encoding is not context-adaptive, and every number in the interval gets a fixed chance (close to a uniform distribution, hence the name).
uni_int(<em>b</em>) denotes an integer of <em>b</em> bits, i.e. it&#8217;s a synonym for rac24(0,2^<em>b</em>-1).</p>
</div>
<div class="paragraph">
<p>nz_int_CONTEXT(<em>min</em>,<em>max</em>) denotes an integer in the interval <em>min</em>..<em>max</em> (inclusive), encoded using Near-zero symbol coding (see below) and a 24-bit RAC, where the chance table is given by CONTEXT. This encoding is context-adaptive; numbers are encoded using a zero-sign-exponent-mantissa representation, which favors distributions in which near-zero values have a higher chance.</p>
</div>
<div class="sect2">
<h3 id="_uniform_symbol_coding">Uniform Symbol Coding</h3>
<div class="paragraph">
<p>An integer encoded with Uniform symbol coding uses a series of 50% chance bits to recursively narrow down the input interval
until it is a singleton. The following code describes how to decode such an integer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c">    <span class="comment">// assumption: min &lt;= max</span>
    <span class="predefined-type">int</span> read_uniform_int(<span class="predefined-type">int</span> min, <span class="predefined-type">int</span> max) {
        <span class="keyword">if</span> (min == max) <span class="keyword">return</span> min;

        <span class="comment">// split in [min..mid] [mid+1..max]</span>
        <span class="predefined-type">int</span> med = min + (max-min)/<span class="integer">2</span>;

        <span class="keyword">if</span> (rac.read_bit()) {
            <span class="keyword">return</span> read_uniform_int(mid+<span class="integer">1</span>, max);
        } <span class="keyword">else</span> {
            <span class="keyword">return</span> read_uniform_int(min, mid);
        }
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>There is no compression advantage of using a RAC to encode these 50% chance bits (just regular bits would be just as efficient),
but it is convenient to use the RAC anyway to avoid having to mix the RAC bitstream with regular bits.</p>
</div>
<div class="paragraph">
<p>For intervals of the form 0..2^<em>k</em> this representation boils down to writing down the number as <em>k</em> binary bits;
for other intervals it can be slightly more concise than binary notation.</p>
</div>
<div class="paragraph">
<p>This representation is used mostly for simple signaling, where context adaptation would be of little use.</p>
</div>
</div>
<div class="sect2">
<h3 id="_near_zero_symbol_coding">Near-zero symbol coding</h3>
<div class="paragraph">
<p>This is the representation used for the bulk of the data, including the pixel values. It is very efficient for values that
are close to zero (e.g. well-predicted pixels).</p>
</div>
<div class="paragraph">
<p>An integer encoded with Near-zero symbol coding uses a zero-sign-exponent-mantissa representation, where the exponent is represented
in unary notation.
Every bit position of this representation has its own RAC context (so their chances adapt separately); the exponent bits use different chances
not just depending on their position but also depending on the sign.
Chances are represented as 12-bit numbers (1..4095), where 1 means that the bit is very likely to be zero (it has 1/4096 chance of being one),
while 4095 means that the bit is very likely to be one (the chance is 4095/4096).</p>
</div>
<div class="paragraph">
<p>The chances are initialized as follows:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">bit</th>
<th class="tableblock halign-left valign-top">initial chance</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ZERO</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1000</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SIGN</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2048</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">EXP(0,<em>sign</em>)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1000</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">EXP(1,<em>sign</em>)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1200</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">EXP(2,<em>sign</em>)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1500</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">EXP(3,<em>sign</em>)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1750</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">EXP(4,<em>sign</em>)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2000</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">EXP(5,<em>sign</em>)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2300</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">EXP(6,<em>sign</em>)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2800</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">EXP(7,<em>sign</em>)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2400</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">EXP(8,<em>sign</em>)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2300</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">EXP(9,<em>sign</em>)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2048</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">EXP(<em>k</em>,<em>sign</em>), <em>k</em> &gt; 9</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2048</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MANT(0)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1900</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MANT(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1850</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MANT(2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1800</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MANT(3)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1750</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MANT(4)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1650</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MANT(5)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1600</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MANT(6)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1600</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MANT(7)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2048</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MANT(<em>k</em>), <em>k</em> &gt; 7</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2048</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The following code describes how to decode an integer in this representation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c">    <span class="comment">// assumption: min &lt;= 0 &lt;= max</span>
    <span class="predefined-type">int</span> read_nearzero_int(<span class="predefined-type">int</span> min, <span class="predefined-type">int</span> max) {

        <span class="keyword">if</span> (min == max) <span class="keyword">return</span> min;

        <span class="keyword">if</span> (rac.read(ZERO)) <span class="keyword">return</span> <span class="integer">0</span>;

        <span class="predefined-type">bool</span> sign; <span class="comment">// true = positive, false = negative</span>
        <span class="keyword">if</span> (min &lt; <span class="integer">0</span>) {
          <span class="keyword">if</span> (max &gt; <span class="integer">0</span>) {
            <span class="comment">// only actually read the sign bit if both signs are possible</span>
            sign = rac.read(SIGN);
          } <span class="keyword">else</span> {
            <span class="comment">// max &lt;= 0 and the number is not zero, so it is negative</span>
            sign = <span class="predefined-constant">false</span>;
          }
        } <span class="keyword">else</span> {
          <span class="comment">// min &gt;= 0 and the number is not zero, so it is positive</span>
          sign = <span class="predefined-constant">true</span>;
        }

        <span class="comment">// highest possible absolute value</span>
        <span class="directive">const</span> <span class="predefined-type">int</span> amax = (sign? max : -min);

        <span class="comment">// highest possible exponent</span>
        <span class="directive">const</span> <span class="predefined-type">int</span> emax = ilog2(amax);

        <span class="comment">// exponent is represented in unary: a series of 1s followed by 0</span>
        <span class="comment">// (the end 0 is dropped if e=emax)</span>
        <span class="predefined-type">int</span> e;
        <span class="keyword">for</span> (e = <span class="integer">0</span> ; e &lt; emax ; e++) {
            <span class="keyword">if</span> (rac.read(EXP(e,sign)) <span class="keyword">break</span>;
        }

        <span class="comment">// the first mantissa bit is always 1</span>
        <span class="predefined-type">int</span> have = (<span class="integer">1</span> &lt;&lt; e);
        <span class="comment">// if all other mantissa bits are 1, then the total is have+left</span>
        <span class="predefined-type">int</span> left = have-<span class="integer">1</span>;

        <span class="comment">// read mantissa bits from most-significant to least-significant</span>
        <span class="keyword">for</span> (<span class="predefined-type">int</span> pos = e; pos&gt;<span class="integer">0</span>;) {
            left &gt;&gt;= <span class="integer">1</span>; pos--;
            <span class="comment">// if the bit is 1, then the value will be at least minabs1</span>
            <span class="predefined-type">int</span> minabs1 = have | (<span class="integer">1</span>&lt;&lt;pos);
            <span class="comment">// if the bit is 0, then the value will be at most maxabs0</span>
            <span class="predefined-type">int</span> maxabs0 = have | left;
            <span class="keyword">if</span> (minabs1 &gt; amax) {
                <span class="comment">// 1-bit is impossible (would bump value above maximum),</span>
                <span class="comment">// so assume the bit is 0 without reading it</span>
            } <span class="keyword">else</span> <span class="keyword">if</span> (maxabs0 &gt;= <span class="integer">1</span>) {
                <span class="comment">// 0-bit and 1-bit are both possible,</span>
                <span class="comment">// so we read the bit and adjust what we have if it is a 1</span>
                <span class="keyword">if</span> (rac.read(MANT(pos))) have = minabs1;
            } <span class="keyword">else</span> {
                <span class="comment">// 0-bit is impossible (would make the value zero),</span>
                <span class="comment">// so assume the bit is 1 without reading it</span>
                have = minabs1;
            }
        }
        <span class="keyword">return</span> (sign ? have : -have);
    }</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_part_3_second_header">Part 3: second header</h2>
<div class="sectionbody">
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Condition</th>
<th class="tableblock halign-left valign-top">Default value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1 byte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NUL byte (0x00), chunk name of a FLIF16 bitstream</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">uni_int(1,16)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bits per pixel of the channels</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Bpc</strong> == '0': repeat(<strong>nb_channels</strong>)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">8 if <strong>Bpc</strong> == '1', 16 if <strong>Bpc</strong> == '2'</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">uni_int(0,1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Flag: <strong>alpha_zero</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>nb_channels</strong> &gt; 3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">uni_int(0,100)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number of loops</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>nb_frames</strong> &gt; 1</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">uni_int(0,60_000)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Frame delay in ms</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>nb_frames</strong> &gt; 1: repeat(<strong>nb_frames</strong>)</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">uni_int(0,1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Flag: <strong>has_custom_cutoff_and_alpha</strong></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">uni_int(1,128)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>cutoff</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>has_custom_cutoff_and_alpha</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">uni_int(2,128)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>alpha divisor</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>has_custom_cutoff_and_alpha</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">19</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">uni_int(0,1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Flag: <strong>has_custom_bitchance</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>has_custom_cutoff_and_alpha</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">?</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bitchance</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>has_custom_bitchance</strong></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Transformations (see below)</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">uni_int(1) = 0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Indicator bit: done with transformations</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">uni_int(0,2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Invisible pixel predictor</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>alpha_zero</strong> &amp;&amp; interlaced &amp;&amp; alpha range includes zero</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Channels are ordered as follows:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Channel number</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Red or Gray</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Green</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Blue</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Alpha</p></td>
</tr>
</tbody>
</table>
<h3 id="_transformations" class="discrete">Transformations</h3>
<div class="paragraph">
<p>For each transformation:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">uni_int(1) = 1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Indicator bit: not done yet</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">uni_int(0,13)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Transformation identifier</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Transformation data (depends on transformation)</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Transformations have to be encoded in ascending order of transformation identifier. All transformations are optional.</p>
</div>
<div class="paragraph">
<p>Transformations serve two main purposes:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>to modify the pixel data (in a reversible way) to make it compress better, and</p>
</li>
<li>
<p>to keep track of the range of actually occuring pixel values, in order to narrow it down.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Initially, pixel values are assumed to be in the range 0..2^(bit_depth); this range can be modified by transformations.
We&#8217;ll use <strong>range(<em>channel</em>).min</strong> and <strong>range(<em>channel</em>).max</strong> to denote the global minimum and maximum value of a particular channel.</p>
</div>
<div class="paragraph">
<p>We also use a potentially more accurate (narrow) conditional range <strong>crange(<em>channel</em>,<em>values</em>)</strong> to denote
the range of a pixel value in channel <strong><em>channel</em></strong>, <em>given that the pixel values in previously encoded channels are</em> <strong><em>values</em></strong>.
Initially, the conditional ranges are simply equal to the global range, but transformations might change that.</p>
</div>
<div class="paragraph">
<p>Finally, we define a function <strong>snap(<em>channel</em>,<em>values</em>,<em>x</em>)</strong> which given a pixel value <strong><em>x</em></strong> for channel <strong><em>channel</em></strong>
and pixel values <strong><em>values</em></strong> in previously encoded channels, returns a 'valid' value as close as possible to <strong><em>x</em></strong>.
Usually, <strong>snap(<em>channel</em>,<em>values</em>,<em>x</em>)</strong> simply clamps <strong><em>x</em></strong> to the conditional range <strong>crange(<em>channel</em>,<em>values</em>)</strong>,
but the ColorBuckets transformation changes that behavior.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Example</div>
<div class="paragraph">
<p>As a typical example, consider 8-bit RGBA to which the YCoCg transformation gets applied:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Channel number</th>
<th class="tableblock halign-left valign-top">Original meaning</th>
<th class="tableblock halign-left valign-top">Original range</th>
<th class="tableblock halign-left valign-top">New meaning</th>
<th class="tableblock halign-left valign-top">New range</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Red</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0..255</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Luma (Y)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0..255</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Green</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0..255</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Chroma orange (Co)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-255..255</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Blue</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0..255</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Chroma green (Cg)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-255..255</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Alpha</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0..255</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Alpha</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0..255</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>In this example, the conditional ranges also change: e.g. <strong>crange(1,2)</strong> (the range for Co given that Y=2) happens to be -7..7.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>In the following descriptions of transformations, we use <strong>orig_range</strong>, <strong>orig_crange</strong>, <strong>orig_snap</strong> to denote
the original ranges and snap function (the initial ones, or the ones resulting from the previous transformation in the chain).
We use <strong>new_range</strong>, <strong>new_crange</strong>, <strong>new_snap</strong> to denote the updated ranges and snap function.</p>
</div>
<div class="paragraph">
<p>In part 4 we will use <strong>range</strong>, <strong>crange</strong> and <strong>snap</strong> to denote the final ranges and snap functions, i.e. after applying all
transformations.</p>
</div>
<div class="paragraph">
<p>We will now describe the transformations and their encoding in more detail.</p>
</div>
<div class="sect2">
<h3 id="_transformation_0_channelcompact">Transformation 0: ChannelCompact</h3>
<div class="paragraph">
<p>The ChannelCompact transformation looks at each channel independently, and reduces its range
by eliminating values that do not actually occur in the image.</p>
</div>
<div class="paragraph">
<p>To be able to reconstruct the original values, the mapping from the reduced range to the original
range is encoded. Near-zero symbol coding is used, with a single context which we&#8217;ll call A.</p>
</div>
<div class="paragraph">
<p>The information is encoded as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>For each channel <strong>c</strong> :</p>
<div class="ulist">
<ul>
<li>
<p><strong>new_range(c).max</strong> = nz_int_A(0,<strong>orig_range(c).max</strong>-<strong>orig_range(c).max</strong>)</p>
</li>
<li>
<p><strong>min</strong> = <strong>orig_range(c).min</strong></p>
</li>
<li>
<p>For <strong>i</strong> = 0..<strong>new_range(c).max</strong>-1 :</p>
<div class="ulist">
<ul>
<li>
<p><strong>decompacted(i)</strong> = <strong>min</strong> + nz_int_A(0, <strong>orig_range(c).max</strong>-<strong>min</strong>+<strong>new_range(c).max</strong>-<strong>i</strong>)</p>
</li>
<li>
<p><strong>min</strong> = <strong>decompacted(i)</strong>+1</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>The effect of this transformation is as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>new_range(c).min = new_crange(c,&#8230;&#8203;).min = 0</strong></p>
</li>
<li>
<p><strong>new_range(c).max = new_crange(c,&#8230;&#8203;).max</strong> is explicitly encoded</p>
</li>
<li>
<p><strong>new_snap</strong> is the default snap function (simple clamping)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To reverse the transformation (after decoding the pixel values) :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>For each channel <strong>c</strong> :</p>
<div class="ulist">
<ul>
<li>
<p>For every pixel value <strong>v</strong> :</p>
<div class="ulist">
<ul>
<li>
<p>Set <strong>v</strong> = <strong>decompacted(v)</strong></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_transformation_1_ycocg">Transformation 1: YCoCg</h3>
<div class="paragraph">
<p>The YCoCg transformation converts the colorspace from RGB to YCoCg.
No information has to be encoded for this (besides the identifier of the transformation).</p>
</div>
<div class="paragraph">
<p>The transformation only affects the first three channels (0,1,2).</p>
</div>
<div class="sect3">
<h4 id="_pixel_transformation">Pixel transformation</h4>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Channel</th>
<th class="tableblock halign-left valign-top">Original meaning</th>
<th class="tableblock halign-left valign-top">New meaning</th>
<th class="tableblock halign-left valign-top">Forward transform</th>
<th class="tableblock halign-left valign-top">Reverse transform</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Red (R)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Luma (Y)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Y = (((R+B)&gt;&gt;1) + G)&gt;&gt;1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">R = Co + Y + ((1-Cg)&gt;&gt;1) - (Co&gt;&gt;1)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Green (G)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Chroma orange (Co)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Co = R - B</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">G = Y - ((-Cg)&gt;&gt;1)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Blue (B)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Chroma green (Cg)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cg = G - ((R+B)&gt;&gt;1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">B = Y + ((1-Cg)&gt;&gt;1) - (Co&gt;&gt;1)</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
&gt;&gt;1 denotes arithmetic right shift, which corresponds to dividing by two <strong>rounding down</strong>.
For positive integers this is the same as /2, but for negative integers it is not, e.g. -1 / 2 = 0 while -1 &gt;&gt; 1 = -1.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Luma (Y) corresponds to roughly 50% green, 25% red, 25% blue. Chroma orange (Co) is positive for colors near orange (red, orange, yellow),
and negative for colors near blue. Chroma green (Cg) is positive for colors near green and negative for colors near purple.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The YCoCg transformation tends to decorrelate the channels, which helps to improve compression.
For example, for grayscale images, i.e. images where R=G=B, the result of the YCoCg transform is Y=R (=G=B), Co=Cg=0.
Human perception is more sensitive to luma than it is to chroma. For this reason, in interlaced mode,
the default zoomlevel/channel ordering (see below) gives priority to the luma channel; this results in
partial decodes (progressive previews) which are effectively chroma subsampled.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_new_ranges">New ranges</h4>
<div class="paragraph">
<p>Define <em>origmax4</em> to be equal to max(<strong>orig_range(0).max</strong>,<strong>orig_range(1).max</strong>,<strong>orig_range(2).max</strong>)/4+1
and <em>newmax</em> to be equal to 4 * (<em>origmax4</em>) - 1.
In the most common case where the three channels have the range 0..255, this evaluates to <em>origmax4</em> = 64 and <em>newmax</em> = 255.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Channel number <strong>c</strong></th>
<th class="tableblock halign-left valign-top">Original meaning</th>
<th class="tableblock halign-left valign-top">New meaning</th>
<th class="tableblock halign-left valign-top"><strong>new_range(c)</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Red (R)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Luma (Y)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0..<em>newmax</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Green (G)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Chroma orange (Co)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-<em>newmax</em>..<em>newmax</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Blue (B)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Chroma green (Cg)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-<em>newmax</em>..<em>newmax</em></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Unlike the RGB color space, not every coordinate in the YCoCg color space corresponds
to an actual color. In particular, the range for Co and Cg is much smaller for near-black and
near-white colors than for intermediate luma values:</p>
</div>
<div class="videoblock">
<div class="content">
<iframe width="512" height="512" src="https://www.youtube.com/embed/-v-xoKZBnhI?rel=0&amp;modestbranding=1" frameborder="0" allowfullscreen></iframe>
</div>
</div>
<div class="paragraph">
<p>(Download the above animation losslessly:
<a href="illustrations/YCoCg.webp">WebP (847K)</a>,
<a href="illustrations/YCoCg.apng">APNG (938K)</a>,
<a href="illustrations/YCoCg.flif">FLIF (90K)</a>;
or lossy:
<a href="illustrations/YCoCg.gif">GIF (7024K)</a>,
<a href="illustrations/YCoCg.mp4">MP4 (235K)</a>)</p>
</div>
<div class="paragraph">
<p>The conditional range function <strong>crange</strong> is updated to reflect this.
It is updated as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>new_crange(0)</strong> = <strong>new_range(0)</strong></p>
</li>
<li>
<p><strong>new_crange(1,<em>yval</em>).min</strong> =</p>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
-3 + 4 * <em>yval</em>        
</td>
<td class="hdlist2">
<p>if <em>yval</em> &lt; <em>origmax4</em> - 1</p>
</td>
</tr>
<tr>
<td class="hdlist1">
4 * (<em>yval</em>-<em>newmax</em>)  
</td>
<td class="hdlist2">
<p>if <em>yval</em> &gt; 3 * <em>origmax4</em> - 1</p>
</td>
</tr>
<tr>
<td class="hdlist1">
-<em>newmax</em>              
</td>
<td class="hdlist2">
<p>otherwise</p>
</td>
</tr>
</table>
</div>
</li>
<li>
<p><strong>new_crange(1,<em>yval</em>).max</strong> =</p>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
3 + 4 * <em>yval</em>         
</td>
<td class="hdlist2">
<p>if <em>yval</em> &lt; <em>origmax4</em> - 1</p>
</td>
</tr>
<tr>
<td class="hdlist1">
4 * (<em>newmax</em>-<em>yval</em>)  
</td>
<td class="hdlist2">
<p>if <em>yval</em> &gt; 3 * <em>origmax4</em> - 1</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<em>newmax</em>               
</td>
<td class="hdlist2">
<p>otherwise</p>
</td>
</tr>
</table>
</div>
</li>
<li>
<p><strong>new_crange(2,<em>yval</em>,<em>coval</em>).min</strong> =</p>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
-2 - 2 * <em>yval</em>        
</td>
<td class="hdlist2">
<p>if <em>yval</em> &lt; <em>origmax4</em> - 1</p>
</td>
</tr>
<tr>
<td class="hdlist1">
-2 * (<em>newmax</em>-<em>yval</em>) + 2 * ((abs(<em>coval</em>)+1)/2)  
</td>
<td class="hdlist2">
<p>if <em>yval</em> &gt; 3 * <em>origmax4</em> - 1</p>
</td>
</tr>
<tr>
<td class="hdlist1">
min(2 * <em>yval</em> + 1, 2 * <em>newmax</em> - 2 * <em>yval</em> - 2 * abs(<em>coval</em>)+1)/2      
</td>
<td class="hdlist2">
<p>otherwise</p>
</td>
</tr>
</table>
</div>
</li>
<li>
<p><strong>new_crange(2,<em>yval</em>,<em>coval</em>).max</strong> =</p>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
1 + 2 * <em>yval</em> - 2 * (abs(<em>coval</em>)/2)        
</td>
<td class="hdlist2">
<p>if <em>yval</em> &lt; <em>origmax4</em> - 1</p>
</td>
</tr>
<tr>
<td class="hdlist1">
2 * (<em>newmax</em>-<em>yval</em>)                        
</td>
<td class="hdlist2">
<p>if <em>yval</em> &gt; 3 * <em>origmax4</em> - 1</p>
</td>
</tr>
<tr>
<td class="hdlist1">
min(2 * (<em>yval</em>- <em>newmax</em>), - 2 * <em>yval</em> - 1 + 2* (abs(<em>coval</em>)/2))            
</td>
<td class="hdlist2">
<p>otherwise</p>
</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
<h3 id="_transformation_2_reserved_unused" class="discrete">Transformation 2: reserved (unused)</h3>
<div class="paragraph">
<p>Transformation identifier 2 is not used. It is reserved for future extensions that support transformations
to other color spaces like YCbCr.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_transformation_3_permuteplanes">Transformation 3: PermutePlanes</h3>

</div>
<div class="sect2">
<h3 id="_transformation_4_bounds">Transformation 4: Bounds</h3>

</div>
<div class="sect2">
<h3 id="_transformation_5_palettealpha">Transformation 5: PaletteAlpha</h3>

</div>
<div class="sect2">
<h3 id="_transformation_6_palette">Transformation 6: Palette</h3>

</div>
<div class="sect2">
<h3 id="_transformation_7_colorbuckets">Transformation 7: ColorBuckets</h3>
<h3 id="_transformation_8_reserved_unused" class="discrete">Transformation 8: reserved (unused)</h3>
<h3 id="_transformation_9_reserved_unused" class="discrete">Transformation 9: reserved (unused)</h3>
</div>
<div class="sect2">
<h3 id="_transformation_10_duplicateframe">Transformation 10: DuplicateFrame</h3>

</div>
<div class="sect2">
<h3 id="_transformation_11_frameshape">Transformation 11: FrameShape</h3>

</div>
<div class="sect2">
<h3 id="_transformation_12_framelookback">Transformation 12: FrameLookback</h3>
<h3 id="_transformation_13_reserved_unused" class="discrete">Transformation 13: reserved (unused)</h3>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_maniac_entropy_coding">MANIAC entropy coding</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Meta-Adaptive Near-zero Integer Arithmetic Coding (MANIAC) is a variant of <a href="https://en.wikipedia.org/wiki/Context-adaptive_binary_arithmetic_coding">Context-adaptive binary arithmetic coding</a> (CABAC) in which not just the probability model is adaptive (based on local context), but also the context model <em>itself</em> is adaptive. In this sense, it is <em>meta-adaptive</em>.</p>
</div>
<div class="paragraph">
<p>The symbol encoding itself corresponds to the Near-zero symbol coding method described above. The chance table (the chances for ZERO, SIGN, EXP(p,s) and MANT(p)) depends on the local context; these chances adapt each time a symbol is encoded or decoded.</p>
</div>
<div class="paragraph">
<p>The local context is described as a vector of integer numbers, which are called <em>properties</em>. To determine which chance table to use, a decision tree is used. This tree is called a <em>MANIAC tree</em>. The full structure of the tree is known in advance by the decoder (it is encoded in part 4 of the bitstream, see below). However, at decode time, the tree is initially only partially used (only the root node at the beginning), and it 'grows' to eventually become the full tree.</p>
</div>
<div class="paragraph">
<p>The inner nodes of a MANIAC tree contain a test of the form <code>property[k] &gt; value</code>. If this test evaluates to <code>true</code>, then the left branch is taken, otherwise the right branch is taken. Eventually a leaf node is reached.</p>
</div>
<div class="paragraph">
<p>The leaf nodes of a MANIAC tree contain a counter and a chance table. This chance table is used in the Near-zero symbol coding. The counter gets decremented each time the leaf node is reached. When it reaches zero, the tree 'grows' and the leaf node becomes an inner node (a decision node). Its chance table gets duplicated and becomes the chance table of its two branch nodes.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Design rationale: MANIAC vs regular CABAC</div>
<div class="paragraph">
<p>In context-adaptive binary arithmetic coding, it is hard to define a good context model;
in particular, to get the number of contexts 'just right'.
Using too many contexts hurts compression because context adaptation is limited
(few encoded symbols per context).
With too few contexts, compression also suffers
since symbols with different local context properties end up in the same context.
Also, when the contexts are defined statically,
a lot of the contexts are actually not used at all since the corresponding
combination of properties simply does not occur in the source image.</p>
</div>
<div class="paragraph">
<p>MANIAC encoding solves this problem using meta-adaptation. The number of contexts (i.e. the number of leaf nodes in the MANIAC tree) can be image-dependent. Moreover, because the tree is 'grown' as more and more symbols are encoded (using the counters), the number of contexts is not static, but it also grows during encoding. This means that you can have fast early adaptation (because there are only a small number of contexts), which will ensure that the chances converge quickly to a rough distribution, while you can also have a very fine-grained adaptation later on, with as many contexts as needed to represent the influence of local properties on the probability distributions.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_part_4_pixel_data">Part 4: pixel data</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_non_interlaced_method">Non-Interlaced method</h3>
<div class="paragraph">
<p>If this encode method is used, then we start immediately with the encoding of the MANIAC trees (see below), followed by the encoding of the pixels. The order in which the pixels are encoded is described by the following nested loops:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>For all channels <em>c</em> : (in the order 4,3,0,1,2, skipping those that don&#8217;t exist or have a singleton range)</p>
<div class="ulist">
<ul>
<li>
<p>For all rows <em>y</em>, i.e. for <em>y</em> from 0 to <strong>height</strong>-1 :</p>
<div class="ulist">
<ul>
<li>
<p>For all frames <em>f</em> , i.e. for <em>f</em> from 0 to <strong>nb_frames</strong>-1 :</p>
<div class="ulist">
<ul>
<li>
<p>For all columns <em>x</em>, i.e. for <em>x</em> from 0 to <strong>width</strong>-1 :</p>
<div class="ulist">
<ul>
<li>
<p>Encode the pixel at location (<em>x</em>,<em>y</em>) in channel <em>c</em> of frame <em>f</em></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>How the pixel is actually encoded is described below.</p>
</div>
</div>
<div class="sect2">
<h3 id="_interlaced_method">Interlaced method</h3>
<div class="paragraph">
<p>For interlacing, we define the notion of <em>zoomlevels</em>. Zoomlevel 0 is the full image. Zoomlevel 1 are all the even-numbered rows of the image (counting from 0). Zoomlevel 2 are all the even-numbered columns of zoomlevel 1. In general: zoomlevel <em>2k+1</em> are all the even-numbered rows of zoomlevel <em>2k</em>, and zoomlevel <em>2k+2</em> are all the even-numbered columns of zoomlevel <em>2k+1</em>.</p>
</div>
<div class="paragraph">
<p>In other words, every even-numbered zoomlevel <em>2k</em> is a downsampled version of the image, at scale 1:<em>2^k</em>.</p>
</div>
<div class="paragraph">
<p>We define the 'maximum zoomlevel' <strong>max_zl</strong> of an image as the zoomlevel with the lowest number that consists of a single pixel. This is always the pixel in the top-left corner of the image (row 0, column 0). This pixel is always encoded first, as a special case.</p>
</div>
<div class="paragraph">
<p>The zoomlevels are encoded from highest (most zoomed out) to lowest; in each zoomlevel, obviously only those pixels are encoded that haven&#8217;t been encoded previously. So in an even-numbered zoomlevel, the odd-numbered rows are encoded, while in an odd-numbered zoomlevel, the odd-numbered columns are encoded.</p>
</div>
<div class="paragraph">
<p>If the interlaced encode method is used, we do not encode the MANIAC trees right away. Instead, we initialize the trees to a single root node per channel, and start encoding a 'rough preview' of the image (a few of the highest zoomlevels).
This allows a rough thumbnail extraction without needing to decode the MANIAC tree.
Then the MANIAC tree is encoded, and then the rest of the zoomlevels are encoded.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Condition</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">uni_int(0..<strong>max_zl</strong>)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number of the first MANIAC-encoded zoomlevel: <strong>first_zl</strong></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">uni_int(range(<em>c</em>).min,range(<em>c</em>).max)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">pixel value of the top-left (0,0) pixel of channel <em>c</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">repeat(<em>c</em> in 0..<strong>nb_channels</strong>-1)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Encode_zoomlevels(<strong>max_zl</strong>-1,<strong>first_zl</strong>+1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">encoding of zoomlevels <strong>max_zl</strong>-1 until <strong>first_zl</strong>+1</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">encoding of MANIAC trees</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">see further below</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Encode_zoomlevels(<strong>first_zl</strong>,0)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">encoding of zoomlevels <strong>first_zl</strong> until 0</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The encoding of a series of zoomlevels happens by interleaving the channels in some way. This interleaving is either in the 'default order', or in a custom order. In any case, the following invariants must hold:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Zoomlevel <em>k</em> of a channel can only be encoded after zoomlevel <em>k+1</em> of that channel has already been encoded;</p>
</li>
<li>
<p>If channel 3 exists and <strong>alpha_zero</strong> is true, then zoomlevel <em>k</em> of channel 0 (usually Luma) can only be encoded after zoomlevel <em>k</em> of channel 3 (Alpha) has already been encoded;</p>
</li>
<li>
<p>Zoomlevel <em>k</em> of channel 1 (usually Co) can only be encoded after zoomlevel <em>k</em> of channel 0 (usually Luma) has been encoded;</p>
</li>
<li>
<p>Zoomlevel <em>k</em> of channel 2 (usually Cg) can only be encoded after zoomlevel <em>k</em> of channels 0 and 1 (Luma and Co) have been encoded;</p>
</li>
<li>
<p>If channel 4 (FrameLookback) exists: zoomlevel <em>k</em> of any other channel (0,1,2, or 3) can only be encoded after zoomlevel <em>k</em> of channel 4 has already been encoded.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>TODO: describe default order</p>
</div>
<div class="sect3">
<h4 id="_encode_zoomlevels_h_l">Encode_zoomlevels(h,l)</h4>
<div class="paragraph">
<p>There are three different pixel predictors in interlaced mode (numbered 0, 1, 2). For each channel, either the same predictor is used in all zoomlevels h to l (in that case the predictor number is encoded only once), or a different predictor can be picked for each zoomlevel (in that case the number -1 is encoded, and the actual predictor number is encoded at the beginning of each zoomlevel).</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Condition</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">uni_int(0,1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Boolean: <strong>default_order</strong></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">uni_int(-1,2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Pixel predictors <strong>pred[channel]</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">repeat(<strong>nb_channels</strong>)</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Repeat <strong> nb_channels * (h-l+1) </strong> times: (once for every channel/zoomlevel in the range from <strong>h</strong> to <strong>l</strong>)</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Condition</th>
<th class="tableblock halign-left valign-top">Default value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">uni_int(0,<strong>nb_channels</strong>-1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Channel <strong>c</strong> to be encoded</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">not <strong>default_order</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">given by default order</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Zoomlevel <strong>z</strong> is implicit</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">uni_int(0,2)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Pixel predictor <strong>p</strong> to use</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>pred[c]</strong> == -1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>pred[c]</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Encode_zl(<strong>c</strong>,<strong>z</strong>,<strong>p</strong>)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Encoding of the next zoomlevel of channel <strong>c</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>range(c).min &lt; range(c).max</strong></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The encoding of a single zoomlevel/channel combination is defined as follows:</p>
</div>
<div class="paragraph">
<p>Encode_zl(<strong>c</strong>,<strong>z</strong>,<strong>p</strong>) :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If <strong>z</strong> is even (a 'horizontal' zoomlevel)</p>
<div class="ulist">
<ul>
<li>
<p>For all <em>odd</em> rows <em>y</em> of zoomlevel <strong>z</strong>, i.e. for <em>y</em> from 1 to (<strong>height</strong>-1)/(2^(<strong>z</strong>/2)) in steps of 2 :</p>
<div class="ulist">
<ul>
<li>
<p>For all frames <em>f</em>, i.e. for <em>f</em> from 0 to <strong>nb_frames</strong>-1 :</p>
<div class="ulist">
<ul>
<li>
<p>For all columns <em>x</em> of zoomlevel <strong>z</strong>, i.e. for <em>x</em> from 0 to (<strong>width</strong>-1)/(2^(<strong>z</strong>/2)) :</p>
<div class="ulist">
<ul>
<li>
<p>Encode the pixel at location (<em>x</em>,<em>y</em>) in zoomlevel <strong>z</strong> of channel <strong>c</strong> of frame <em>f</em>, using predictor <strong>p</strong></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Else (if <strong>z</strong> is odd, that is, a 'vertical' zoomlevel)</p>
<div class="ulist">
<ul>
<li>
<p>For all rows <em>y</em> of zoomlevel <strong>z</strong>, i.e. for <em>y</em> from 0 to (<strong>height</strong>-1)/(2^(<strong>z+1</strong>/2)) :</p>
<div class="ulist">
<ul>
<li>
<p>For all frames <em>f</em>, i.e. for <em>f</em> from 0 to <strong>nb_frames</strong>-1 :</p>
<div class="ulist">
<ul>
<li>
<p>For all <em>odd</em> columns <em>x</em> of zoomlevel <strong>z</strong>, i.e. for <em>x</em> from 1 to (<strong>width</strong>-1)/(2^(<strong>z</strong>/2)) with steps of 2 :</p>
<div class="ulist">
<ul>
<li>
<p>Encode the pixel at location (<em>x</em>,<em>y</em>) in zoomlevel <strong>z</strong> of channel <strong>c</strong> of frame <em>f</em>, using predictor <strong>p</strong></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Design rationale: Animation loop nesting</div>
<div class="paragraph">
<p>Both in the interlaced and in the non-interlaced mode, the frames of an animation are
interleaved at a relatively deep level of the nested loops.
This means that progressive decoding of an animation does not result in the first few frames at full quality,
but instead, you get all frames at reduced quality. In non-interlaced mode, early stages of progressive decoding
will give you the top portion of all frames, only in grayscale (assuming the YCoCg color transformation).
In interlaced mode, progressive decoding will give you a blurry / low resolution preview of the full animation.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_pixel_encoding">Pixel encoding</h3>
<div class="paragraph">
<p>The overall encoding mechanism of a pixel value <em>v</em> is as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The value is predicted, resulting in a predicted value <em>guess</em></p>
</li>
<li>
<p>The range of possible values is computed as accurately as possible using <strong>crange(c,&#8230;&#8203;)</strong>, resulting in <em>min</em> and <em>max</em></p>
<div class="ulist">
<ul>
<li>
<p>If needed, <em>guess</em> is adjusted to be in this range</p>
</li>
</ul>
</div>
</li>
<li>
<p>The local context of the pixel is computed as a MANIAC property vector <em>pvec</em></p>
</li>
<li>
<p>The number that actually gets encoded is the difference between the actual and predicted value <em>v</em> - <em>guess</em></p>
<div class="ulist">
<ul>
<li>
<p>If the prediction is any good, these numbers tend to be close to zero</p>
</li>
<li>
<p>To decode the value: nz_int_MANIAC<sub><strong>c</strong>,<em>pvec</em></sub>(<em>min</em>-<em>guess</em>, <em>max</em>-<em>guess</em>) + <em>guess</em></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>The above mechanism is the same in interlaced and non-interlaced mode and for all channels; however the predictor (<em>guess</em>) and the layout of property vector (<em>pvec</em>) depends on the mode and the channel.</p>
</div>
<div class="sect3">
<h4 id="_skipped_pixels">Skipped pixels</h4>
<div class="paragraph">
<p>Some pixels are not encoded at all. There are three such cases:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>If the <strong>alpha_zero</strong> flag is true, then 'invisible pixels' (pixels with Alpha value zero) semantically have undefined RGB values. So if the pixel value in channel 3 (Alpha) is equal to 0, then the pixel values in channels 0, 1, 2 (RGB, or e.g. YCoCg after transformations) are not encoded. However, the decoder does need to set the values of these pixels to <em>something</em>, since those 'invisible' values might very well be used in predictors or properties of neighboring <em>visible</em> pixels. It sets these values simply to the predicted value. In interlaced mode, the predictor to use for that is called the 'invisible pixel predictor' (see part 3 above).</p>
</li>
<li>
<p>In animations which use the FrameShape transformation, from the second frame onwards, all rows have a 'begin' and 'end' column. Pixels before the begin and after the end are not encoded; their value is equal to the corresponding pixel value from the previous frame.</p>
</li>
<li>
<p>In animations which use the FrameLookback transformation, channel 4 (Lookback) refers to past frames. If the value in channel 4 is not zero but some number <em>k</em> &gt; 0, then all other channels are not encoded for that pixel. The pixel value for channels 0,1,2,3 is equal to the corresponding pixel value from <em>k</em> frames ago.</p>
</li>
</ol>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
As an optimization, it is safe to simply skip pixels from a constant channel, that is, a channel which has a singleton range. Technically, one could argue that they are actually encoded, but for each pixel value <em>v</em>, we have <em>v</em> = <em>min</em> = <em>max</em> = <em>guess</em>, which means the symbol encoding doesn&#8217;t use any bits.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_pixel_predictors">Pixel predictors</h4>
<div class="sect4">
<h5 id="_non_interlaced_mode">Non-interlaced mode</h5>

</div>
<div class="sect4">
<h5 id="_interlaced_mode">Interlaced mode</h5>

</div>
</div>
<div class="sect3">
<h4 id="_properties">Properties</h4>
<div class="sect4">
<h5 id="_non_interlaced_mode_2">Non-interlaced mode</h5>

</div>
<div class="sect4">
<h5 id="_interlaced_mode_2">Interlaced mode</h5>

</div>
</div>
</div>
<div class="sect2">
<h3 id="_maniac_tree_encoding">MANIAC tree encoding</h3>
<div class="paragraph">
<p>There is one tree per non-trivial channel (a channel is trivial if its range is a singleton or if it doesn&#8217;t exist).
The trees are encoded one after another and in a recursive (depth-first) way, as follows:</p>
</div>
<div class="paragraph">
<p><strong>nb_properties</strong> depends on the channel, the number of channels, and the encoding method (interlaced or non-interlaced),
as specified above. The range of each property is maintained during tree traversal. The initial property ranges
<strong>prange[<em>property</em>]</strong> are defined above; these are narrowed down when going to a deeper node in the tree.</p>
</div>
<div class="paragraph">
<p>For each channel <em>c</em>, three different contexts are used: we&#8217;ll just call them A<sub><em>c</em></sub>, B<sub><em>c</em></sub> and C<sub><em>c</em></sub>.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Condition</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">nz_int_A<sub><em>c</em></sub>(0,<strong>nb_properties</strong>)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0=leaf node, &gt; 0: <em>property</em>+1</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">nz_int_B<sub><em>c</em></sub>(1,512)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">node counter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">not a leaf node</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">nz_int_C<sub><em>c</em></sub>(<strong>prange[<em>property</em>].min</strong>,<strong>prange[<em>property</em>].max</strong>-1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>test_value</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">not a leaf node</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">recursive encoding of left branch</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">where <strong>prange[<em>property</em>].min</strong> = <em>test_value</em>+1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">not a leaf node</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">recursive encoding of right branch</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">where <strong>prange[<em>property</em>].max</strong> = <em>test_value</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">not a leaf node</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>From this description, the MANIAC trees can be reconstructed. Leaf nodes have a counter value that is effectively infinity
(they can never be turned into a decision node).</p>
</div>
</div>
<div class="sect2">
<h3 id="_checksum">Checksum</h3>
<div class="paragraph">
<p>At the very end of the bitstream, there is an optional checksum to verify the integrity of the file.</p>
</div>
<div class="paragraph">
<p>TODO: describe how the checksum is computed</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Condition</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">uni_int(1)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Boolean: <strong>have_checksum</strong></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">uni_int(16)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Most significant 16 bits of checksum</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>have_checksum</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">uni_int(16)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Least significant 16 bits of checksum</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>have_checksum</strong></p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2016-12-08 12:03:55 CET
</div>
</div>
</body>
</html>